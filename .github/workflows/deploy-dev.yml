name: Deploy to Dev

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  NODE_VERSION: "20"
  TERRAFORM_VERSION: "1.9.0"

concurrency:
  group: deploy-dev-${{ github.ref }}
  cancel-in-progress: false

jobs:
  ##############################################################################
  # Verify Bootstrap Resources
  ##############################################################################
  verify-bootstrap:
    name: Verify Bootstrap
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify bootstrap resources exist
        run: |
          set -euo pipefail

          echo "Verifying bootstrap resources..."

          # Check S3 state bucket
          if ! aws s3api head-bucket --bucket portfolio-pconti-tfstate 2>/dev/null; then
            echo "::error::Terraform state bucket 'portfolio-pconti-tfstate' not found. Run bootstrap first."
            exit 1
          fi
          echo "✓ S3 state bucket: OK"

          # Check DynamoDB lock table
          if ! aws dynamodb describe-table --table-name portfolio-pconti-tf-lock >/dev/null 2>&1; then
            echo "::error::DynamoDB lock table 'portfolio-pconti-tf-lock' not found. Run bootstrap first."
            exit 1
          fi
          echo "✓ DynamoDB lock table: OK"

          echo "All bootstrap resources verified successfully"

  ##############################################################################
  # Build Frontend (Next.js with OpenNext)
  ##############################################################################
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: [verify-bootstrap]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: "frontend/pnpm-lock.yaml"

      - name: Install dependencies
        working-directory: ./frontend
        run: pnpm install --frozen-lockfile

      - name: Build Next.js with OpenNext
        working-directory: ./frontend
        env:
          NEXT_PUBLIC_PAYLOAD_API_URL: https://api.${{ secrets.DOMAIN_NAME }}
        run: |
          set -euo pipefail

          echo "Building Next.js application..."
          pnpm build

          echo "Building OpenNext package for AWS Lambda..."
          pnpm dlx @opennextjs/aws build

          echo "OpenNext build complete"
          ls -la .open-next/

          test -d .open-next || { echo "::error::.open-next directory missing after build"; exit 1; }

      - name: Upload OpenNext frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: opennext-frontend-build
          path: frontend/.open-next/
          include-hidden-files: true
          if-no-files-found: error
          retention-days: 1

  ##############################################################################
  # Build Backend (Payload CMS with OpenNext)
  ##############################################################################
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    needs: [verify-bootstrap]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: "backend/pnpm-lock.yaml"

      - name: Install dependencies
        working-directory: ./backend
        run: |
          pnpm install --frozen-lockfile
          # Reinstall sharp with ARM64 Linux binaries for Lambda
          pnpm remove sharp
          npm install --cpu=arm64 --os=linux --libc=glibc sharp@0.34.2

      - name: Build Payload with OpenNext
        working-directory: ./backend
        env:
          # These are build-time placeholders - actual values injected at runtime via Lambda env vars
          DATABASE_URI: postgresql://placeholder:placeholder@localhost:5432/placeholder
          PAYLOAD_SECRET: build-time-placeholder-secret-minimum-length
        run: |
          set -euo pipefail

          echo "Building Payload application..."
          pnpm build

          echo "Building OpenNext package for AWS Lambda..."
          pnpm dlx @opennextjs/aws build

          echo "OpenNext build complete"
          ls -la .open-next/

          test -d .open-next || { echo "::error::.open-next directory missing after build"; exit 1; }

      - name: Upload OpenNext backend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: opennext-backend-build
          path: backend/.open-next/
          include-hidden-files: true
          if-no-files-found: error
          retention-days: 1

  ##############################################################################
  # Deploy Infrastructure (Terraform)
  ##############################################################################
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [build-frontend, build-backend]
    permissions:
      id-token: write
      contents: read
    outputs:
      frontend_url: ${{ steps.outputs.outputs.frontend_url }}
      api_url: ${{ steps.outputs.outputs.api_url }}
      cloudfront_distribution_id: ${{ steps.outputs.outputs.cloudfront_distribution_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download OpenNext frontend build artifact
        uses: actions/download-artifact@v4
        with:
          name: opennext-frontend-build
          path: frontend/.open-next

      - name: Download OpenNext backend build artifact
        uses: actions/download-artifact@v4
        with:
          name: opennext-backend-build
          path: backend/.open-next

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Create terraform.tfvars
        working-directory: ./infra
        run: |
          set -euo pipefail

          # Decode tfvars from base64 secret
          printf '%s' "${{ secrets.TFVARS_CONTENT_DEV_B64 }}" | base64 -d > terraform.tfvars

          # Normalize line endings
          tr -d '\r' < terraform.tfvars > tf.tmp && mv tf.tmp terraform.tfvars

          echo "terraform.tfvars created ($(wc -l < terraform.tfvars) lines)"

      - name: Terraform Init
        working-directory: ./infra
        run: terraform init -input=false

      - name: Terraform Validate
        working-directory: ./infra
        run: terraform validate

      - name: Terraform Plan
        working-directory: ./infra
        run: |
          terraform plan \
            -var-file=terraform.tfvars \
            -out=tfplan \
            -input=false

      - name: Terraform Apply
        working-directory: ./infra
        run: terraform apply -auto-approve -input=false tfplan

      - name: Get Terraform outputs
        id: outputs
        working-directory: ./infra
        run: |
          echo "frontend_url=$(terraform output -raw frontend_url)" >> "$GITHUB_OUTPUT"
          echo "api_url=$(terraform output -raw payload_url)" >> "$GITHUB_OUTPUT"
          echo "cloudfront_distribution_id=$(terraform output -raw cloudfront_distribution_id)" >> "$GITHUB_OUTPUT"

  ##############################################################################
  # Invalidate CloudFront Cache
  ##############################################################################
  invalidate-cache:
    name: Invalidate CloudFront
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure]
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Invalidate CloudFront cache
        run: |
          set -euo pipefail

          DISTRIBUTION_ID="${{ needs.deploy-infrastructure.outputs.cloudfront_distribution_id }}"

          if [ -n "$DISTRIBUTION_ID" ] && [ "$DISTRIBUTION_ID" != "None" ]; then
            echo "Invalidating CloudFront distribution: $DISTRIBUTION_ID"

            INVALIDATION_ID=$(aws cloudfront create-invalidation \
              --distribution-id "$DISTRIBUTION_ID" \
              --paths "/*" \
              --query 'Invalidation.Id' \
              --output text)

            echo "Invalidation created: $INVALIDATION_ID"
          else
            echo "No CloudFront distribution ID found, skipping invalidation"
          fi

  ##############################################################################
  # Health Checks
  ##############################################################################
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, invalidate-cache]

    steps:
      - name: Wait for propagation
        run: sleep 30

      - name: Check frontend health
        run: |
          set -euo pipefail

          FRONTEND_URL="${{ needs.deploy-infrastructure.outputs.frontend_url }}"
          echo "Testing frontend: $FRONTEND_URL"

          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$FRONTEND_URL" || echo "000")

            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "✓ Frontend health check passed (HTTP $HTTP_CODE)"
              break
            fi

            echo "Attempt $i: HTTP $HTTP_CODE, retrying in 10s..."
            sleep 10
          done

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "::warning::Frontend returned HTTP $HTTP_CODE"
          fi

      - name: Check API health
        run: |
          set -euo pipefail

          API_URL="${{ needs.deploy-infrastructure.outputs.api_url }}"
          ADMIN_URL="${API_URL}/admin"
          echo "Testing Payload admin: $ADMIN_URL"

          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$ADMIN_URL" || echo "000")

            if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 302 ]; then
              echo "✓ API health check passed (HTTP $HTTP_CODE)"
              break
            fi

            echo "Attempt $i: HTTP $HTTP_CODE, retrying in 10s..."
            sleep 10
          done

          if [ "$HTTP_CODE" -ne 200 ] && [ "$HTTP_CODE" -ne 302 ]; then
            echo "::warning::API health check returned HTTP $HTTP_CODE"
          fi

  ##############################################################################
  # Deployment Summary
  ##############################################################################
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, health-check]
    if: always()

    steps:
      - name: Print deployment summary
        run: |
          echo "=============================================="
          echo "         DEPLOYMENT SUMMARY"
          echo "=============================================="
          echo ""
          echo "Commit:     ${{ github.sha }}"
          echo "Branch:     ${{ github.ref_name }}"
          echo "Actor:      ${{ github.actor }}"
          echo ""
          echo "Frontend:   ${{ needs.deploy-infrastructure.outputs.frontend_url }}"
          echo "API:        ${{ needs.deploy-infrastructure.outputs.api_url }}"
          echo ""
          echo "=============================================="
